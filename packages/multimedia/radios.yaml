media_player:
  - platform: squeezebox
    host: !secret squeezebox_host
    port: 9002
    players:
      - name: "Arbeitszimmer"        
        playerid: !secret squeezebox_mac_arbeitszimmer
      - name: "Badezimmer"
        playerid: !secret squeezebox_mac_badezimmer
      - name: "Balkon"
        playerid: !secret squeezebox_mac_balkon
      - name: "Flur"
        playerid: !secret squeezebox_mac_flur
      - name: "Küche"
        playerid: !secret squeezebox_mac_kueche
      - name: "Schlafzimmer"
        playerid: !secret squeezebox_mac_schlafzimmer
      - name: "Wohnzimmer"
        playerid: !secret squeezebox_mac_wohnzimmer
      - name: "Smarthome"
        playerid: !secret squeezebox_mac_smarthome

switch:
  - platform: edimax
    host: 192.168.2.36
    name: Wohnzimmer Radio

  - platform: edimax
    host: 192.168.2.30
    name: Schlafzimmer Radio

  - platform: brematic
    host: !secret brematic_host
    switches:
      balkon_radio:
        friendly_name: Balkon Radio
        system_code: "11100"
        unit_code: "01000"

  - platform: template
    switches:
      wiedergabe_badezimmer:
        friendly_name: Wiedergabe Badezimmer
        value_template: >-
          {{ is_state('media_player.badezimmer', 'playing') }}
        icon_template: >-
          {{ 'mdi:play-circle-outline' if is_state('media_player.badezimmer', 'playing') else 'mdi:pause-circle-outline' }}
        turn_on:
          - service: media_player.media_play
            data:
              entity_id: media_player.badezimmer
        turn_off:
          - service: media_player.media_pause
            data:
              entity_id: media_player.badezimmer

      alle_radios_wiedergabe_aktiv:
        friendly_name: Wiedergabe aktiv
        value_template: >-
          {% if is_state('media_player.kuche', 'playing')
            or is_state('media_player.badezimmer', 'playing')
            or is_state('media_player.wohnzimmer', 'playing')
            or is_state('media_player.schlafzimmer', 'playing')
            or is_state('media_player.arbeitszimmer', 'playing')
            or is_state('media_player.flur', 'playing')
            or is_state('media_player.balkon', 'playing')
          %}
            True
          {% else %}
            False
          {% endif %}
        icon_template: >-
          {% if is_state('media_player.kuche', 'playing')
            or is_state('media_player.badezimmer', 'playing')
            or is_state('media_player.wohnzimmer', 'playing')
            or is_state('media_player.schlafzimmer', 'playing')
            or is_state('media_player.arbeitszimmer', 'playing')
            or is_state('media_player.flur', 'playing')
            or is_state('media_player.balkon', 'playing')
          %}
            mdi:play-circle-outline
          {% else %}
            mdi:pause-circle-outline
          {% endif %}
        turn_on:
          service: script.radios_starten
        turn_off:
          service: script.radios_pausieren

      alle_radios:
        friendly_name: Alle Radios
        value_template: >-
          {% if is_state('switch.wohnzimmer_radio', 'on')
            or is_state('switch.balkon_radio', 'on')
            or is_state('switch.schlafzimmer_radio', 'on')
            or is_state('switch.flur_radio', 'on')
            or is_state('switch.badezimmer_radio', 'on')
            or is_state('switch.arbeitszimmer_radio', 'on')
            or is_state('switch.kuche_radio', 'on')
          %}
            True
          {% else %}
            False
          {% endif %}
        turn_on:
          service: script.radios_einschalten
        turn_off:
          service: script.radios_ausschalten

input_boolean:
  radio_aktiv_balkon:
    name: Radio Balkon aktiv
  musik_pausiert:
    name: Musik pausiert
    initial: off

binary_sensor:
  - platform: template
    sensors:
      radio_badezimmer_inaktiv:
        friendly_name: Radio Badezimmer inaktiv
        device_class: motion
        value_template: >-
          {% if is_state('entity_controller.radio_badezimmer_bewegung', 'active_timer') %}
            false
          {% elif is_state('media_player.badezimmer', 'playing') %}
            true
          {% elif is_state('switch.wohnzimmer_radio', 'on')
            or is_state('switch.balkon_radio', 'on')
            or is_state('switch.schlafzimmer_radio', 'on')
            or is_state('switch.flur_radio', 'on')
            or is_state('switch.arbeitszimmer_radio', 'on')
            or is_state('switch.kuche_radio', 'on')
          %}
            true
          {% else %}
            false
          {% endif %}

automation:
  - alias: 'Radio Balkon - Bewegung erkannt'
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_balkon
        to: 'on'
    condition:
      - condition: time
        after: '08:00'
        before: '22:00'
      - condition: or
        conditions:
          - condition: time
            after: '08:00'            
            before: '12:00'           
          - condition: time
            after: '15:00'
            before: '22:00'  
      - condition: template
        value_template: '{{ now().isoweekday() != 7 }}'   
      - condition: state
        entity_id: 'switch.alle_radios_wiedergabe_aktiv'
        state: 'on'
      - condition: state
        entity_id: 'media_player.balkon'
        state: 'off'
      - condition: state
        entity_id: 'device_tracker.pibalcony'
        state: 'home'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.radio_aktiv_balkon
      - service: media_player.turn_on
        data:
          entity_id: media_player.balkon

  - alias: 'Radio Balkon - Keine Bewegung'
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_wohnzimmer
        to: 'on'
    condition:
      - condition: state
        entity_id: input_boolean.radio_aktiv_balkon
        state: 'on'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.radio_aktiv_balkon
      - service: media_player.turn_off
        data:
          entity_id: media_player.balkon

  - alias: 'Radio Balkon - Synchronisieren'
    trigger:
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          entity_id: binary_sensor.schalter_balkon
          click_type: single
    condition:
      - condition: state
        entity_id: switch.balkon_radio
        state: 'on'
    action:
      - service: script.sync_radios

  - alias: 'Radios pausieren - Tür geöffnet'
    trigger:
      - platform: state
        entity_id: binary_sensor.tuersensor
        to: 'on'
    condition:
      - condition: state
        entity_id: switch.alle_radios_wiedergabe_aktiv
        state: 'on'
      - condition: template
        value_template: >-
          {% set now = as_timestamp(now()) | int %}
          {% set last = as_timestamp(state_attr("automation.alles_ausschalten", "last_triggered")) | int %}
          {% set diff = ((now - last) / 60) | int %}

          {{ diff >= 10 }}
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.musik_pausiert
      - service: media_player.volume_mute
        data:
          entity_id: media_player.kuche, media_player.badezimmer, media_player.wohnzimmer, media_player.schlafzimmer, media_player.arbeitszimmer, media_player.flur, media_player.balkon
          is_volume_muted: true        

  - alias: 'Radios starten - Tür geschlossen'
    trigger:
      - platform: state
        entity_id: binary_sensor.tuersensor
        to: 'off'
    condition:
      - condition: state
        entity_id: input_boolean.musik_pausiert
        state: 'on'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.musik_pausiert
      - service: media_player.volume_mute
        data:
          entity_id: media_player.kuche, media_player.badezimmer, media_player.wohnzimmer, media_player.schlafzimmer, media_player.arbeitszimmer, media_player.flur, media_player.balkon
          is_volume_muted: false    
          
  - alias: 'Radio eingeschaltet - Starten und synchronisieren'
    trigger:
      - platform: state
        entity_id: device_tracker.piliving
        to: 'home'
      - platform: state
        entity_id: device_tracker.picorridor
        to: 'home'
      - platform: state
        entity_id: device_tracker.pibath
        to: 'home'
      - platform: state
        entity_id: device_tracker.pikitchen
        to: 'home'
      - platform: state
        entity_id: device_tracker.piworking
        to: 'home'
      - platform: state
        entity_id: device_tracker.pisleeping
        to: 'home'        
    condition:
      - condition: state
        entity_id: switch.alle_radios_wiedergabe_aktiv
        state: 'on'
    action:
      - service: script.radios_starten
      - delay: '00:00:10'
      - service: script.sync_radios  
          
script:
  sync_radios:
    alias: Radios synchronisieren
    sequence:
      - condition: state
        entity_id: media_player.wohnzimmer
        state: 'playing'
      - service: media_player.turn_off
        entity_id: media_player.wohnzimmer
      - delay: '00:00:02'
      - service: media_player.turn_on
        entity_id: media_player.wohnzimmer

  radios_einschalten:
    alias: Radios einschalten
    sequence:
      - service: switch.turn_on
        entity_id: switch.wohnzimmer_radio, switch.balkon_radio, switch.flur_radio, switch.badezimmer_radio, switch.kuche_radio, switch.schlafzimmer_radio, switch.arbeitszimmer_radio

  radios_ausschalten:
    alias: Radios ausschalten
    sequence:
      - service: script.radios_pausieren
      - service: switch.turn_off
        entity_id: switch.wohnzimmer_radio, switch.balkon_radio, switch.flur_radio, switch.badezimmer_radio, switch.kuche_radio, switch.schlafzimmer_radio, switch.arbeitszimmer_radio

  radios_starten:
    alias: Radios abspielen
    sequence:
      - service: media_player.media_play
        entity_id: media_player.kuche, media_player.badezimmer, media_player.wohnzimmer, media_player.schlafzimmer, media_player.arbeitszimmer, media_player.flur

  radios_pausieren:
      alias: Radios pausieren
      sequence:
        - service: media_player.media_pause
          entity_id: media_player.kuche, media_player.badezimmer, media_player.wohnzimmer, media_player.schlafzimmer, media_player.arbeitszimmer, media_player.flur

homeassistant:
  customize:
    script.sync_radios:
      can_cancel: false
      icon: mdi:sync
    switch.alle_radios:
      icon: mdi:cast-off

    switch.wohnzimmer_radio:
      icon: mdi:radio
    switch.schlafzimmer_radio:
      icon: mdi:radio

    media_player.badezimmer:
      friendly_name: Radio Badezimmer
    media_player.arbeitszimmer:
      friendly_name: Radio Arbeitszimmer
    media_player.flur:
      friendly_name: Radio Flur
    media_player.kuche:
      friendly_name: Radio Küche
    media_player.schlafzimmer:
      friendly_name: Radio Schlafzimmer
    media_player.wohnzimmer:
      friendly_name: Radio Wohnzimmer
    media_player.balkon:
      friendly_name: Radio Balkon