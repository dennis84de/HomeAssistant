notify:
  - platform: kodi
    name: Kodi Wohnzimmer
    host: !secret computer_host
    username: !secret kodi_username
    password: !secret kodi_password
    
input_boolean:
  musik_ausschalten:
    name: Musik ausschalten
    icon: mdi:music-off
    
  kodi_wohnzimmer_pausiert:
    name: Kodi Wohnzimmer pausiert    
  kodi_wohnzimmer_pausieren:
    name: Kodi Wohnzimmer pausieren    
    icon: mdi:sync-off

  youtube_wohnzimmer_pausiert:
    name: Youtube Wohnzimmer pausiert    
  youtube_wohnzimmer_pausieren:
    name: Youtube Wohnzimmer pausieren    
    icon: mdi:sync-off
    
binary_sensor:
  - platform: mqtt
    name: "Kodi Wohnzimmer - MQTT"    
    state_topic: "kodi_wohnzimmer/connected"
    payload_on: "2"
    payload_off: "0"
    device_class: connectivity
    json_attributes_topic: "kodi_wohnzimmer/status/progress"
    json_attributes_template: "{{ value_json | tojson }}"   

  - platform: mqtt
    name: "Youtube aktiv"   
    state_topic: "iotlink/workgroup/computer/process-monitor/processes/firefox/sensor"
    value_template: >-    
      {% if not value_json %}
        {{ 'OFF' }}
      {% else %}        
        {{ 'ON' if value_json.FullScreen == 'True' else 'OFF' }}      
      {% endif %}   
    
cover:
  - platform: template
    covers:
      kodi_untertitel:
        friendly_name: "Untertitel"
        position_template: 50
        open_cover:
          service: kodi.call_method
          data:
            entity_id: media_player.kodi_wohnzimmer
            method: Input.ExecuteAction
            action: subtitledelayplus
        close_cover:
          service: kodi.call_method
          data:
            entity_id: media_player.kodi_wohnzimmer
            method: Input.ExecuteAction
            action: subtitledelayminus
        stop_cover:
          service: kodi.call_method
          data:
            entity_id: media_player.kodi_wohnzimmer
            method: Input.ExecuteAction
            action: showsubtitles
        icon_template: >-
          mdi:message-bulleted      

      fernseher_sender:
        friendly_name: "Fernseher Sender"
        position_template: 50
        open_cover:
          - service: media_player.play_media
            data:
              entity_id: media_player.fernseher_wohnzimmer
              media_content_id: "KEY_CHUP"
              media_content_type: "send_key"
        close_cover:
          - service: media_player.play_media
            data:
              entity_id: media_player.fernseher_wohnzimmer
              media_content_id: "KEY_CHDOWN"
              media_content_type: "send_key"
        stop_cover:
          - service: media_player.play_media
            data:
              entity_id: media_player.fernseher_wohnzimmer
              media_content_id: "KEY_PRECH"
              media_content_type: "send_key"
        icon_template: >-
          mdi:remote-tv

switch:
  - platform: template
    switches:
      watchtv_wohnzimmer:
        friendly_name: "Fernsehen"
        value_template: "{{ is_state('media_player.fernseher_wohnzimmer', 'on') }}"
        turn_on:
          - service: media_player.turn_on
            entity_id: media_player.fernseher_wohnzimmer  
          - choose:
              - conditions:
                  - condition: state
                    entity_id: media_player.soundbar
                    state: 'off'
                sequence:  
                  - service: media_player.turn_on
                    entity_id: media_player.soundbar        
                  - wait_template: "{{is_state('media_player.soundbar', 'on')}}"
                  - service: media_player.select_source
                    entity_id: media_player.soundbar
                    data:
                      source: TV
        turn_off:
          - service: media_player.media_stop
            entity_id: media_player.kodi_wohnzimmer
          - wait_template: "{{is_state('media_player.kodi_wohnzimmer', 'idle')}}"
            timeout: '00:00:02'
            continue_on_timeout: 'true'
          - service: media_player.turn_off
            entity_id: media_player.kodi_wohnzimmer
          - wait_template: "{{is_state('media_player.kodi_wohnzimmer', 'off')}}"
            timeout: '00:00:02'
            continue_on_timeout: 'true'          
          - service: media_player.turn_off
            entity_id: media_player.fernseher_wohnzimmer
          - choose:
              - conditions:
                  - condition: state
                    entity_id: media_player.soundbar
                    state: 'on'
                sequence:
                  - service: media_player.turn_off
                    entity_id: media_player.soundbar
          
automation:      
  - alias: "Kodi Wohnzimmer - Musik ausschalten"
    trigger:
      - platform: state
        entity_id: media_player.kodi_wohnzimmer
        from: 'off'
        to: 'idle'
    condition:
      - condition: state
        state: 'on'
        entity_id: switch.alle_radios
      - condition: state
        state: 'on'
        entity_id: input_boolean.musik_ausschalten
      - condition: numeric_state
        entity_id: sensor.laufzeit_minuten
        above: 2
    action:
      - service: script.radios_pausieren
      - service: switch.turn_off
        entity_id: switch.wohnzimmer_radio, switch.balkon_radio, switch.flur_radio, switch.kuche_radio, switch.schlafzimmer_radio, switch.arbeitszimmer_radio     

  - alias: "Kodi Wohnzimmer - Wiedergabe Schalter"
    trigger:
      - platform: state
        entity_id: binary_sensor.schalter_wohnzimmer
        to: 'off'
    condition:
      - condition: or
        conditions:
        - condition: state
          entity_id: media_player.kodi_wohnzimmer
          state: 'playing'
        - condition: state
          entity_id: media_player.kodi_wohnzimmer
          state: 'paused'
    action:
      - service: media_player.media_play_pause
        entity_id: media_player.kodi_wohnzimmer
            
  - alias: "Kodi Wohnzimmer - Widergabe Cube"
    trigger:
      - platform: state
        entity_id: sensor.cube_bewegung
    condition:
      - condition: template
        value_template: '{{ True if "flip90" in trigger.to_state.state else False }}'
      - condition: or
        conditions:
        - condition: state
          entity_id: media_player.kodi_wohnzimmer
          state: 'playing'
        - condition: state
          entity_id: media_player.kodi_wohnzimmer
          state: 'paused'
    action:
      - service: media_player.media_play_pause
        entity_id: media_player.kodi_wohnzimmer
           
  - alias: "Kodi Wohnzimmer - Cube - Nächster Titel"
    trigger:
      - platform: state
        entity_id: sensor.cube_bewegung
    condition:
      - condition: template
        value_template: '{{ True if "drop" in trigger.to_state.state else False }}'         
      - condition: template
        value_template: '{{ is_state("media_player.kodi_wohnzimmer", "off") == False }}'
    action:
      - service: media_player.media_next_track
        entity_id: media_player.kodi_wohnzimmer

  - alias: "Kodi Wohnzimmer - Cube - Untertitel"
    trigger:
      - platform: state
        entity_id: sensor.cube_bewegung
    condition:
      - condition: template
        value_template: '{{ True if "shake" in trigger.to_state.state else False }}'         
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'        
    action:
      - service: cover.stop_cover
        entity_id: cover.kodi_untertitel

  - alias: "Kodi Wohnzimmer - Wiedergabe pausieren - Bewegung Flur"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_flur_vorne
        to: 'on'
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_flur_hinten
        to: 'on'
    condition:
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'
      - condition: state
        entity_id: input_boolean.kodi_wohnzimmer_pausieren
        state: 'on'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'        
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'
    action:
      - service: media_player.media_pause
        entity_id: media_player.kodi_wohnzimmer        
      - service: input_boolean.turn_on
        entity_id: input_boolean.kodi_wohnzimmer_pausiert

  - alias: "Kodi Wohnzimmer - Wiedergabe pausieren - Bewegung Balkon"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_balkon
        to: 'on'
    condition:
      - condition: state
        entity_id: binary_sensor.balkontuer
        state: 'on'      
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'
      - condition: state
        entity_id: input_boolean.kodi_wohnzimmer_pausieren
        state: 'on'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'            
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'
    action:
      - service: media_player.media_pause
        entity_id: media_player.kodi_wohnzimmer        
      - service: input_boolean.turn_on
        entity_id: input_boolean.kodi_wohnzimmer_pausiert

  - alias: "Kodi Wohnzimmer - Wiedergabe pausieren - Schalter Balkon"
    trigger:
      - platform: state
        entity_id: sensor.schalter_balkon
        to: '2'
    condition:
      - condition: state
        entity_id: binary_sensor.balkontuer
        state: 'on'      
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'
      - condition: state
        entity_id: input_boolean.kodi_wohnzimmer_pausieren
        state: 'on'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'                    
    action:
      - service: media_player.media_pause
        entity_id: media_player.kodi_wohnzimmer        
      - service: input_boolean.turn_on
        entity_id: input_boolean.kodi_wohnzimmer_pausiert

  - alias: "Kodi Wohnzimmer - Wiedergabe starten - Bewegung Wohnzimmer"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_wohnzimmer
        to: 'on'
    condition:
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'paused'
      - condition: state
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
        state: 'on'
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'
    action:
      - service: media_player.media_play
        entity_id: media_player.kodi_wohnzimmer
      - service: input_boolean.turn_off
        entity_id: input_boolean.kodi_wohnzimmer_pausiert

  - alias: "Kodi Wohnzimmer - Wiedergabe gestartet - Licht und Musik ausschalten"
    trigger:
      - platform: state
        entity_id: media_player.kodi_wohnzimmer
        to: 'playing'
    action:
      - service: light.turn_off
        entity_id: light.flur_vorne, light.flur_hinten, light.badezimmerschrank, light.schreibtisch, light.kuche_regal, light.arbeitszimmer_lampe, light.balkon_licht, light.sportzimmer_regal
      - condition: state
        entity_id: media_player.badezimmer
        state: 'playing'
      - service: media_player.media_pause
        entity_id: media_player.badezimmer

  - alias: 'Telefon aktiv - Kodi Wohnzimmer pausieren'
    trigger:
      - platform: state
        entity_id: sensor.telefon
        to: 'ringing'
      - platform: state
        entity_id: sensor.telefon
        to: 'dialing'
    condition:
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'
      - condition: state
        entity_id: input_boolean.nicht_stoeren
        state: 'off'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'          
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
      - service: media_player.media_pause
        entity_id: media_player.kodi_wohnzimmer
      - service: notify.kodi_wohnzimmer
        data:
          title: 'Telefon'
          message: >-
            {% if is_state("sensor.telefon", 'dialing') %}
              {{ state_attr('sensor.telefon', 'to_name') }} ({{ state_attr('sensor.telefon', 'to') }}) wird angerufen.
            {% elif is_state("sensor.telefon", 'ringing') %}
              {% if state_attr('sensor.telefon', 'from') == '' %}
                Ein Anruf ohne Rufnummer.
              {% elif state_attr('sensor.telefon', 'from_name')  == 'unknown' %}
                Ein Anruf von einer unbekannten Rufnummer ({{ state_attr('sensor.telefon', 'from') }}).
              {% else %}
                Anruf von {{ state_attr('sensor.telefon', 'from_name') }} ({{ state_attr('sensor.telefon', 'from') }}).
              {% endif %}
            {% endif %}
          data:
            displaytime: 5000
            icon: "info"

  - alias: 'Telefon inaktiv - Kodi Wohnzimmer wiedergeben'
    trigger:
      - platform: state
        entity_id: sensor.telefon
        to: 'idle'
    condition:
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'paused'
      - condition: state
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
        state: 'on'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'        
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
      - service: media_player.media_play
        entity_id: media_player.kodi_wohnzimmer
      - service: notify.kodi_wohnzimmer
        data:
          title: 'Telefon'
          message: 'Anruf beendet'
          data:
            displaytime: 2000
            icon: "info"          

  - alias: 'Handy aktiv - Kodi Wohnzimmer pausieren'
    trigger:
      - platform: state
        entity_id: sensor.handy
        to: 'incoming'
      - platform: state
        entity_id: sensor.handy
        to: 'outgoing'
    condition:
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'
      - condition: state
        entity_id: input_boolean.nicht_stoeren
        state: 'off'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'              
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
      - service: media_player.media_pause
        entity_id: media_player.kodi_wohnzimmer
      - service: notify.kodi_wohnzimmer
        data:
          title: 'Handy'
          message: >-
            {% set name = state_attr('sensor.handy', 'name') %}
            {% set number = state_attr('sensor.handy', 'number') %}
            
            {% if is_state("sensor.handy", "outgoing") %}
              {% if name == number %}
                {{ state_attr('sensor.handy', 'name') }} wird angerufen.
              {% else %}
                {{ state_attr('sensor.handy', 'name') }} ({{ state_attr('sensor.handy', 'number') }}) wird angerufen.
              {% endif %}
              
            {% elif is_state("sensor.handy", "incoming") %}
              {% if name == number %}
                Eingehender Anruf von {{ state_attr('sensor.handy', 'name') }}.
              {% else %}
                Eingehender Anruf von {{ state_attr('sensor.handy', 'name') }} ({{ state_attr('sensor.handy', 'number') }}).
              {% endif %}                          
            {% endif %}                                 
          data:
            displaytime: 5000
            icon: "info"

  - alias: 'Handy inaktiv - Kodi Wohnzimmer wiedergeben'
    trigger:
      - platform: state
        entity_id: sensor.handy
        to: 'idle'
    condition:
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'paused'
      - condition: state
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
        state: 'on'
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.kodi_wohnzimmer_pausiert
      - service: media_player.media_play
        entity_id: media_player.kodi_wohnzimmer
      - service: notify.kodi_wohnzimmer
        data:
          title: 'Handy'
          message: 'Anruf beendet'
          data:
            displaytime: 2000
            icon: "info"

  - alias: "Youtube Wohnzimmer - Wiedergabe pausieren - Bewegung Flur"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_flur_vorne
        to: 'on'
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_flur_hinten
        to: 'on'
    condition:
      - condition: state
        entity_id: binary_sensor.youtube_aktiv
        state: 'on'
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausieren
        state: 'on'
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
        state: 'off'        
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'        
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
      - service: mqtt.publish
        data:
          topic: "iotlink/workgroup/computer/commands/media/playpause"
          payload: ""

  - alias: "Youtube Wohnzimmer - Wiedergabe pausieren - Bewegung Balkon"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_balkon
        to: 'on'
    condition:
      - condition: state
        entity_id: binary_sensor.youtube_aktiv
        state: 'on'      
      - condition: state
        entity_id: binary_sensor.balkontuer
        state: 'on'      
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausieren
        state: 'on'
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
        state: 'off'     
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'            
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
      - service: mqtt.publish
        data:
          topic: "iotlink/workgroup/computer/commands/media/playpause"
          payload: ""

  - alias: "Youtube Wohnzimmer - Wiedergabe starten - Bewegung Wohnzimmer"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_wohnzimmer
        to: 'on'
    condition:
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
        state: 'on'
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.youtube_wohnzimmer_pausiert      
      - choose:
          - conditions:
            - condition: state
              entity_id: binary_sensor.youtube_aktiv
              state: 'on'
            sequence:
              - service: mqtt.publish
                data:
                  topic: "iotlink/workgroup/computer/commands/media/playpause"
                  payload: ""

  - alias: 'Telefon aktiv - Youtube Wohnzimmer pausieren'
    trigger:
      - platform: state
        entity_id: sensor.telefon
        to: 'ringing'
      - platform: state
        entity_id: sensor.telefon
        to: 'dialing'
    condition:
      - condition: state
        entity_id: binary_sensor.youtube_aktiv
        state: 'on'
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausieren
        state: 'on'        
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
        state: 'off'        
      - condition: state
        entity_id: input_boolean.nicht_stoeren
        state: 'off'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'          
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
      - service: mqtt.publish
        data:
          topic: "iotlink/workgroup/computer/commands/media/playpause"
          payload: ""
          
  - alias: 'Telefon inaktiv - Youtube Wohnzimmer wiedergeben'
    trigger:
      - platform: state
        entity_id: sensor.telefon
        to: 'idle'
    condition:
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
        state: 'on'
      - condition: template
        value_template: '{{ is_state("sensor.handy", "incoming") == False and is_state("sensor.handy", "outgoing") == False }}'        
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.youtube_wohnzimmer_pausiert      
      - choose:
          - conditions:
            - condition: state
              entity_id: binary_sensor.youtube_aktiv
              state: 'on'
            sequence:
              - service: mqtt.publish
                data:
                  topic: "iotlink/workgroup/computer/commands/media/playpause"
                  payload: ""
            
  - alias: 'Handy aktiv - Youtube Wohnzimmer pausieren'
    trigger:
      - platform: state
        entity_id: sensor.handy
        to: 'incoming'
      - platform: state
        entity_id: sensor.handy
        to: 'outgoing'
    condition:
      - condition: state
        entity_id: binary_sensor.youtube_aktiv
        state: 'on'
      - condition: state
        entity_id: input_boolean.nicht_stoeren
        state: 'off'
      - condition: state
        entity_id: binary_sensor.besuch
        state: 'off'              
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
      - service: mqtt.publish
        data:
          topic: "iotlink/workgroup/computer/commands/media/playpause"
          payload: ""

  - alias: 'Handy inaktiv - Youtube Wohnzimmer wiedergeben'
    trigger:
      - platform: state
        entity_id: sensor.handy
        to: 'idle'
    condition:
      - condition: state
        entity_id: input_boolean.youtube_wohnzimmer_pausiert
        state: 'on'
      - condition: state
        entity_id: sensor.telefon
        state: 'idle'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.youtube_wohnzimmer_pausiert      
      - choose:
          - conditions:
            - condition: state
              entity_id: binary_sensor.youtube_aktiv
              state: 'on'
            sequence:
              - service: mqtt.publish
                data:
                  topic: "iotlink/workgroup/computer/commands/media/playpause"
                  payload: ""   
            
  - alias: "Soundbar Lautstärke - Cube"
    trigger:
      - platform: state
        entity_id: sensor.cube_drehung
    condition:
      - condition: state
        entity_id: media_player.soundbar
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.laufzeit_minuten
        above: 5       
      - condition: template
        value_template: >-
          {% set now = as_timestamp(now()) | int %}
          {% set last = as_timestamp(state_attr("automation.soundbar_lautstarke_cube", "last_triggered")) | int %}
          {% set diff = ((now - last)) | int %}

          {{ diff >= 5 }}        
    action:
      - service: media_player.volume_set
        data_template:
          entity_id: media_player.soundbar
          volume_level: >
            {% if is_state('media_player.soundbar', 'off') %}
              {% set oldState = 0 %}
            {% elif state_attr('media_player.soundbar', 'volume_level') == None %}            
              {% set oldState = 0 %}
            {% else %}
              {% set oldState = state_attr('media_player.soundbar', 'volume_level') | float -%}
            {% endif %}

            {% if trigger.to_state.state | float > 0 %}
               {% set newState = oldState + 0.05 -%}
            {% else %}
               {% set newState = oldState - 0.05 -%}
            {% endif %}

            {{ newState }}

homeassistant:
  customize:
    media_player.soundbar:
      icon: mdi:music
          
    switch.watchtv_wohnzimmer:
      icon: mdi:television-classic