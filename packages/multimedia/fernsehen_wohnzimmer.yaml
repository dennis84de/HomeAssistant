notify:
  - platform: kodi
    name: Kodi Wohnzimmer
    host: !secret computer_host
    username: !secret kodi_username
    password: !secret kodi_password
    
input_boolean:
  musik_ausschalten:
    name: Musik ausschalten
    icon: mdi:music-off
    
  wiedergabe_pausieren:
    name: Wiedergabe pausieren
    icon: mdi:play-pause

  kodi_wohnzimmer_pausiert:
    name: Kodi Wohnzimmer pausiert    
    
  multimedia_wohnzimmer_pausiert:
    name:  Multimedia pausiert    
        
media_player: 
  - platform: hass_agent_mediaplayer
    name: "Computer"  
    host: !secret computer_host
  
cover:
  - platform: template
    covers:
      kodi_untertitel:
        friendly_name: "Untertitel"
        position_template: 50
        open_cover:
          service: kodi.call_method
          data:
            entity_id: media_player.kodi_wohnzimmer
            method: Input.ExecuteAction
            action: subtitledelayplus
        close_cover:
          service: kodi.call_method
          data:
            entity_id: media_player.kodi_wohnzimmer
            method: Input.ExecuteAction
            action: subtitledelayminus
        stop_cover:
          service: kodi.call_method
          data:
            entity_id: media_player.kodi_wohnzimmer
            method: Input.ExecuteAction
            action: showsubtitles
        icon_template: mdi:message-bulleted      

      fernseher_sender:
        friendly_name: "Fernseher Sender"
        position_template: 50
        open_cover:
          - service: media_player.play_media
            data:
              entity_id: media_player.fernseher_wohnzimmer
              media_content_id: "KEY_CHUP"
              media_content_type: "send_key"
        close_cover:
          - service: media_player.play_media
            data:
              entity_id: media_player.fernseher_wohnzimmer
              media_content_id: "KEY_CHDOWN"
              media_content_type: "send_key"
        stop_cover:
          - service: media_player.play_media
            data:
              entity_id: media_player.fernseher_wohnzimmer
              media_content_id: "KEY_PRECH"
              media_content_type: "send_key"
        icon_template: >-
          mdi:remote-tv

switch:
  - platform: template
    switches:
      watchtv_wohnzimmer:
        friendly_name: "Fernsehen"
        value_template: "{{ is_state('media_player.fernseher_wohnzimmer', 'on') }}"
        turn_on:
          - service: media_player.turn_on
            entity_id: media_player.fernseher_wohnzimmer  
          - choose:
              - conditions:
                  - condition: state
                    entity_id: media_player.soundbar
                    state: 'off'
                sequence:  
                  - service: media_player.turn_on
                    entity_id: media_player.soundbar        
                  - wait_template: "{{is_state('media_player.soundbar', 'on')}}"
                  - service: media_player.select_source
                    entity_id: media_player.soundbar
                    data:
                      source: TV
        turn_off:
          - service: media_player.media_stop
            entity_id: media_player.kodi_wohnzimmer
          - wait_template: "{{is_state('media_player.kodi_wohnzimmer', 'idle')}}"
            timeout: '00:00:02'
            continue_on_timeout: 'true'
          - service: media_player.turn_off
            entity_id: media_player.kodi_wohnzimmer
          - wait_template: "{{is_state('media_player.kodi_wohnzimmer', 'off')}}"
            timeout: '00:00:02'
            continue_on_timeout: 'true'          
          - service: media_player.turn_off
            entity_id: media_player.fernseher_wohnzimmer           
          - choose:
              - conditions:
                  - condition: state
                    entity_id: media_player.soundbar
                    state: 'on'
                sequence:
                  - service: media_player.turn_off
                    entity_id: media_player.soundbar
     
script:
  wohnzimmer_wiedergabe_starten:
    alias: "Wohnzimmer - Wiedergabe starten"
    sequence:
      - service: homeassistant.turn_off
        entity_id: group.licht_fernsehen         
      - choose:
          - conditions:
              - "{{ device == 'kodi' }}"             
            sequence:
              - service: media_player.media_play
                entity_id: media_player.kodi_wohnzimmer
              - service: input_boolean.turn_off
                entity_id: input_boolean.kodi_wohnzimmer_pausiert
          - conditions:
              - "{{ device == 'computer' }}"             
            sequence:
              - service: media_player.media_play
                entity_id: media_player.computer
              - service: input_boolean.turn_off
                entity_id: input_boolean.multimedia_wohnzimmer_pausiert
      - choose:
          - conditions:
              - "{{ is_state('media_player.radio_badezimmer', 'playing') }}"      
            sequence:
              - service: media_player.media_pause
                entity_id: media_player.radio_badezimmer
        
  wohnzimmer_wiedergabe_pausieren:
    alias: "Wohnzimmer - Wiedergabe pausieren"
    sequence:
      - choose:
          - conditions:
              - "{{ device == 'kodi' }}"             
            sequence:
              - service: media_player.media_pause
                entity_id: media_player.kodi_wohnzimmer        
              - service: input_boolean.turn_on
                entity_id: input_boolean.kodi_wohnzimmer_pausiert
          - conditions:
              - "{{ device == 'computer' }}"             
            sequence:
              - service: media_player.media_pause
                entity_id: media_player.computer   
              - service: input_boolean.turn_on
                entity_id: input_boolean.multimedia_wohnzimmer_pausiert
      - choose:
          - conditions:              
              - condition: template
                value_template: >-
                  {% if triggerId and (triggerId == 'bewegungsmelder_balkon' or triggerId == 'schalter_balkon') %}
                    {{ is_state('binary_sensor.sonne_tagsueber', 'off') }}
                  {% else %}
                    False
                  {% endif %}                  
            sequence:
              - service: switch.turn_on
                entity_id: light.balkon_licht  
                
automation:    
  - alias: "Kodi Wohnzimmer - Einschalten"
    id: "kodi_wohnzimmer_einschalten"
    trigger:
      - platform: device
        device_id: 32e19680f91711eaa516c9e368eb4fd0
        domain: kodi
        entity_id: media_player.kodi_wohnzimmer
        type: turn_on
    condition:
      - "{{ is_state('media_player.kodi_wohnzimmer', 'off') }}"    
    action:
      - service: button.press
        data: {}
        target:
          entity_id: button.computer_kodi
    
  - alias: "Kodi Wohnzimmer - Ausschalten"
    id: "kodi_wohnzimmer_ausschalten"
    trigger:
      - platform: device
        device_id: 32e19680f91711eaa516c9e368eb4fd0
        domain: kodi
        entity_id: media_player.kodi_wohnzimmer
        type: turn_off
    condition:
      - "{{ not is_state('media_player.kodi_wohnzimmer', 'off') }}"            
    action:
      - service: kodi.call_method
        data:
          entity_id: media_player.kodi_wohnzimmer
          method: Application.Quit
  
  - alias: "Kodi Wohnzimmer - Musik ausschalten"
    id: "kodi_wohnzimmer_musik_ausschalten"
    trigger:
      - platform: state
        entity_id: media_player.kodi_wohnzimmer
        from: 'off'
        to: 'idle'
    condition:
      - "{{ (states('sensor.laufzeit_minuten') | int(0)) > 1 }}"   
      - "{{ is_state('input_boolean.musik_ausschalten', 'on') }}"
      - "{{ is_state('binary_sensor.besuch', 'off') }}"
      - "{{ (states('sensor.radios_eingeschaltet') | int(0)) > 1 }}"   
    action:  
      - service: script.radios_ausschalten
        data:
          badezimmerEingeschaltetLassen: True
                 
  - alias: "Kodi Wohnzimmer - NÃ¤chster Titel"
    id: "kodi_wohnzimmer_naechster_titel"
    trigger:
      - id: cube_wohnzimmer
        platform: event
        event_type: zha_event
        event_data:
          device_ieee: 00:15:8d:00:01:10:0d:7a
          command: drop    
    condition:   
      - "{{ is_state('media_player.kodi_wohnzimmer', 'playing') }}"
    action:
      - service: media_player.media_next_track
        entity_id: media_player.kodi_wohnzimmer

  - alias: "Kodi Wohnzimmer - Untertitel"
    id: "kodi_wohnzimmer_untertitel"    
    trigger:
      - id: cube_wohnzimmer
        platform: event
        event_type: zha_event
        event_data:
          device_ieee: 00:15:8d:00:01:10:0d:7a
          command: shake    
    condition:     
      - condition: state
        entity_id: media_player.kodi_wohnzimmer
        state: 'playing'        
    action:
      - service: cover.stop_cover
        entity_id: cover.kodi_untertitel          
          
  - alias: "Kodi Wohnzimmer - Status aktualisieren"
    id: "kodi_wohnzimmer_status_aktualisieren"    
    trigger:
      - platform: state
        entity_id: media_player.kodi_wohnzimmer
        to: 'off'              
    action:
      - service: homeassistant.update_entity
        target:
          entity_id: media_player.kodi_wohnzimmer
          
  - alias: "Wohnzimmer - Wiedergabe"
    id: "wohnzimmer_wiedergabe"    
    trigger:
      - id: schalter_wohnzimmer
        platform: event
        event_type: zha_event
        event_data:
          device_ieee: 00:15:8d:00:02:c8:c4:8b
          command: click
          args:
            click_type: single   
      - id: cube_wohnzimmer
        platform: event
        event_type: zha_event
        event_data:
          device_ieee: 00:15:8d:00:01:10:0d:7a
          command: flip      
    condition:           
      - condition: or
        conditions:
          - "{{ states('media_player.kodi_wohnzimmer') in ['playing', 'paused'] }}"
          - "{{ states('media_player.computer') in ['playing', 'paused'] }}"
    action:
      - choose:
          - conditions:
              - "{{ states('media_player.kodi_wohnzimmer') in ['playing', 'paused'] }}"
            sequence:
              - service: media_player.media_play_pause
                entity_id: media_player.kodi_wohnzimmer
          - conditions:
              - "{{ states('media_player.computer') in ['playing', 'paused'] }}"
            sequence:
              - service: media_player.media_play_pause
                entity_id: media_player.computer                

  - alias: "Wohnzimmer - Wiedergabe starten"
    id: "wohnzimmer_wiedergabe_starten"
    trigger:
      - platform: state
        entity_id: binary_sensor.bewegungsmelder_wohnzimmer
        to: 'on'
    condition:
      - "{{ is_state('sensor.telefon', 'idle') }}"
      - "{{ is_state('sensor.handy', 'idle') }}"
      - condition: or
        conditions:
          - "{{ is_state('input_boolean.kodi_wohnzimmer_pausiert', 'on') and is_state('media_player.kodi_wohnzimmer', 'paused') }}"
          - "{{ is_state('input_boolean.multimedia_wohnzimmer_pausiert', 'on') and is_state('media_player.computer', 'paused') }}"
    action:
      - choose:
          - conditions:
              - "{{ is_state('input_boolean.kodi_wohnzimmer_pausiert', 'on') }}"
            sequence:              
              - service: script.wohnzimmer_wiedergabe_starten
                data: 
                  device: 'kodi'        
          - conditions:
              - "{{ is_state('input_boolean.multimedia_wohnzimmer_pausiert', 'on') }}"
            sequence:              
              - service: script.wohnzimmer_wiedergabe_starten
                data: 
                  device: 'computer'                      
        
  - alias: "Wohnzimmer - Wiedergabe pausieren"
    id: "wohnzimmer_wiedergabe_pausieren"
    trigger:
      - id: bewegungsmelder_flur_vorne
        platform: state
        entity_id: binary_sensor.bewegungsmelder_flur_vorne
        to: 'on'
      - id: bewegungsmelder_flur_hinten
        platform: state
        entity_id: binary_sensor.bewegungsmelder_flur_hinten
        to: 'on'
      - id: bewegungsmelder_balkon
        platform: state
        entity_id: binary_sensor.bewegungsmelder_balkon
        to: 'on'            
      - id: schalter_balkon
        platform: event
        event_type: zha_event
        event_data:
          device_ieee: 00:15:8d:00:02:c7:62:ce
          command: click
          args:
            click_type: double            
    condition:
      - "{{ is_state('binary_sensor.besuch', 'off') }}"
      - "{{ is_state('sensor.telefon', 'idle') }}"
      - "{{ is_state('sensor.handy', 'idle') }}"
      - "{{ is_state('input_boolean.wiedergabe_pausieren', 'on') }}"
      - condition: or
        conditions:
          - "{{ is_state('media_player.kodi_wohnzimmer', 'playing') }}"
          - "{{ is_state('media_player.computer', 'playing') }}"
      - condition: template       
        value_template: >-  
          {% if trigger.id == 'bewegungsmelder_balkon' or trigger.id == 'schalter_balkon' %}
            {{ is_state('binary_sensor.balkontuer', 'on') }}
          {% else %}
            True
          {% endif %}
    action:
      - choose:
          - conditions:
              - "{{ is_state('media_player.kodi_wohnzimmer', 'playing') }}"
            sequence:              
              - service: script.wohnzimmer_wiedergabe_pausieren
                data: 
                  triggerId: trigger.id   
                  device: 'kodi'        
          - conditions:
              - "{{ is_state('media_player.computer', 'playing') }}"
            sequence:              
              - service: script.wohnzimmer_wiedergabe_pausieren
                data: 
                  triggerId: trigger.id   
                  device: 'computer'

homeassistant:
  customize:
    media_player.soundbar:
      icon: mdi:music
          
    switch.watchtv_wohnzimmer:
      icon: mdi:television-classic