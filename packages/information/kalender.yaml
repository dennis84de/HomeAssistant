calendar:
  - platform: caldav
    url: !secret nextcloud_calendar_url
    username: !secret nextcloud_username
    password: !secret nextcloud_password
       
template:
  - binary_sensor:
      - name: "Adventszeit"
        unique_id: adventszeit
        state: >
          {% set first_advent = now().replace(day=25, month=12) - timedelta(days = 21 + now().replace(day=25, month=12).isoweekday() ) %}
          {{ first_advent <= now() <= now().replace(day=26, month=12) }}   
        icon: >
          {% set first_advent = now().replace(day=25, month=12) - timedelta(days = 21 + now().replace(day=25, month=12).isoweekday() ) %}
          {{ 'mdi:string-lights' if first_advent <= now() <= now().replace(day=26, month=12) else 'mdi:string-lights-off' }}                          
          
      - name: 'Urlaub morgen'
        device_class: opening
        state: >-
          {% if state_attr('calendar.urlaub', 'start_time') == None %}
            False
          {% else %}
            {% set nextVacationTime = strptime(state_attr('calendar.urlaub', 'start_time'),'%Y-%m-%d %H:%M:%S', None) %}

            {{ nextVacationTime.strftime('%j')|int - now().strftime('%j')|int == 1 }}          
          {% endif %}
    
      - name: 'Krank morgen'
        device_class: opening
        state: >-
          {% if not state_attr('calendar.arbeit_krank', 'end_time') %}
            False
          {% else %}
            {% set nextEndTime = state_attr('calendar.arbeit_krank', 'end_time') | as_datetime %}

            {{ nextEndTime.strftime('%j')|int - now().strftime('%j')|int >= 1 }}          
          {% endif %}   
          
  - sensor:
      - default_entity_id: sensor.edg_restmuell
        name: Restmüll
        icon: mdi:trash-can
        state: >
          {% if state_attr('calendar.edg_restmuell', 'start_time') %}
            {% set weekday = as_timestamp(state_attr('calendar.edg_restmuell', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

            {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.edg_restmuell', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
          {% else %}
            -
          {% endif %}
        
      - default_entity_id: sensor.edg_wertstoff
        name: Wertstoff
        icon: mdi:recycle
        state: >
          {% if state_attr('calendar.edg_wertstoff', 'start_time') %}
            {% set weekday = as_timestamp(state_attr('calendar.edg_wertstoff', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

            {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.edg_wertstoff', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.edg_papier
        name: Papier
        icon: mdi:newspaper
        state: >
          {% if state_attr('calendar.edg_papier', 'start_time') %}
            {% set weekday = as_timestamp(state_attr('calendar.edg_papier', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

            {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.edg_papier', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.bvb_spiel
        name: Nächstes Spiel
        icon: mdi:soccer
        state: >
          {% if state_attr('calendar.borussia_dortmund', 'message') %}
            {{ state_attr('calendar.borussia_dortmund', 'message') }}
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.bvb_datum
        name: Datum
        icon: mdi:calendar-alert
        state: >
          {% if state_attr('calendar.borussia_dortmund', 'start_time') %}
            {% set weekday = as_timestamp(state_attr('calendar.borussia_dortmund', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

            {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.borussia_dortmund', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.bvb_uhrzeit
        name: Uhrzeit
        icon: mdi:clock-outline
        state: >
          {% if state_attr('calendar.borussia_dortmund', 'start_time') %}
            {% set dateSplitted = state_attr('calendar.borussia_dortmund', 'start_time').split(' ') %}
            {% set timeSplitted = dateSplitted[1].split(':') %}
            {{ timeSplitted[0] ~ ':' ~ timeSplitted[1] ~ ' Uhr' }}            
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.bvb_ort
        name: Ort
        icon: mdi:city
        state: >
          {% if state_attr('calendar.borussia_dortmund', 'location') %}
            {{ state_attr('calendar.borussia_dortmund', 'location') }}
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.dfb_spiel
        name: Nächstes Spiel
        icon: mdi:soccer
        state: >
          {% if state_attr('calendar.nationalmannschaft', 'message') %}
            {% set messageSplitted = state_attr('calendar.nationalmannschaft', 'message').split(' | ') %}

            {% if  messageSplitted|length == 1 %}
              {{ messageSplitted[0] }}
            {% else %}
              {{ messageSplitted[0] ~ ' (' ~ messageSplitted[1] ~ ')' }}
            {% endif %}           
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.dfb_datum
        name: Datum
        icon: mdi:calendar-alert
        state: >
          {% if state_attr('calendar.nationalmannschaft', 'start_time') %}
            {% set weekday = as_timestamp(state_attr('calendar.nationalmannschaft', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

            {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.nationalmannschaft', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.dfb_uhrzeit
        name: Uhrzeit
        icon: mdi:clock-outline
        state: >
          {% if state_attr('calendar.nationalmannschaft', 'start_time') %}
            {% set dateSplitted = state_attr('calendar.nationalmannschaft', 'start_time').split(' ') %}
            {% set timeSplitted = dateSplitted[1].split(':') %}
            {{ timeSplitted[0] ~ ':' ~ timeSplitted[1] ~ ' Uhr' }}            
          {% else %}
            -
          {% endif %}

      - default_entity_id: sensor.dfb_ort
        name: Ort
        icon: mdi:city
        state: >
          {% if state_attr('calendar.nationalmannschaft', 'location') %}
            {% set locationSplitted = state_attr('calendar.nationalmannschaft', 'location').split(' | ') %}

            {% if locationSplitted|length == 2 %}
              {{ locationSplitted[1] }}
            {% else %}
              -
            {% endif %}            
          {% else %}
            -
          {% endif %}
        
      - default_entity_id: sensor.formel1_rennen
        name: Nächstes Rennen
        icon: mdi:car-sports
        state: >       
          {% set rennen = as_timestamp(state_attr('calendar.formel1_rennen', 'start_time'), None) %}
          {% set sprint = as_timestamp(state_attr('calendar.formel1_sprint', 'start_time'), None) %}
          
          {% if sprint == None and rennen == None %}
            {% set location = None %}
          {% elif sprint != None and sprint < rennen %}
            {% set location = state_attr('calendar.formel1_sprint', 'message').split(':')[1].split('/') %}
          {% else %}
            {% set location = state_attr('calendar.formel1_rennen', 'message').split(':')[1].split('/') %}
          {% endif %}
          
          {% if location != None and location != '' %}
            {{ location[1] }} ({{ location[0].strip() }})
          {% else %}
            -
          {% endif %}                                   

      - default_entity_id: sensor.formel1_datum
        name: Datum
        icon: mdi:calendar-alert
        state: >
          {% set rennen = as_timestamp(state_attr('calendar.formel1_rennen', 'start_time'), None) %}
          {% set sprint = as_timestamp(state_attr('calendar.formel1_sprint', 'start_time'), None) %}        
        
          {% if sprint == None and rennen == None %}
            {% set start = None %}
          {% elif sprint != None and sprint < rennen %}
            {% set start = sprint %}
          {% else %}
            {% set start = rennen %}
          {% endif %}

          {% if start == None %}
            -
          {% else %}           
            {{ start | timestamp_custom("%d.%m.%Y", True) | string }}, {{ start | timestamp_custom("%H:%M Uhr") | string }}       
          {% endif %}                 

      - default_entity_id: sensor.formel1_qualifikation
        name: Qualifikation
        icon: mdi:car-sports
        state: >
          {% set qualifikation = state_attr('calendar.formel1_qualifikation', 'start_time') %}
          {% set rennen = state_attr('calendar.formel1_rennen', 'start_time') %}
          
          {% if qualifikation == None or rennen == None %}
            -
          {% else %}
            {% set qualifikationTs = as_timestamp(state_attr('calendar.formel1_qualifikation', 'start_time'), None) %}
            {% set rennenTs = as_timestamp(state_attr('calendar.formel1_rennen', 'start_time'), None) %}
            
            {% if qualifikation > rennen %}
              -
            {% else %}
              {% if state_attr('calendar.formel1_qualifikation', 'start_time') %}
                {{ qualifikationTs | timestamp_custom("%d.%m.%Y", True) | string }}, {{ qualifikationTs | timestamp_custom("%H:%M Uhr") | string }}
              {% else %}
                -
              {% endif %}
            {% endif %}
          {% endif %}               

      - default_entity_id: sensor.naechster_urlaub
        name: Nächster Urlaub
        icon: mdi:sunglasses
        state: >
          {% if state_attr('calendar.urlaub', 'message') %}
            {{ state_attr('calendar.urlaub', 'message') }}
          {% else %}
            -
          {% endif %}
        attributes:
          datum: >
            {% if state_attr('calendar.urlaub', 'start_time') %}             
              {% set weekday = as_timestamp(state_attr('calendar.urlaub', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

              {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.urlaub', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
            {% else %}
              -              
            {% endif %}
          tage: >
            {% set start = as_timestamp(state_attr('calendar.urlaub', 'start_time'), None) | int(0) %}
            {% set heute = as_timestamp(now().replace(hour=0, minute=0, second=0)) | int(0) %}
            
            {{ 0 if start == 0 else ((start - heute) | int / 60 / 60 / 24) | int(0) }}   
             
      - default_entity_id: sensor.naechste_ferien
        name: Nächste Ferien
        icon: mdi:calendar-star
        state: >
          {% if state_attr('calendar.ferien', 'message') %}
            {{ state_attr('calendar.ferien', 'message') }}
          {% else %}
            -
          {% endif %}
        attributes:
          datum: >
            {% if state_attr('calendar.ferien', 'start_time') %}             
              {% set weekday = as_timestamp(state_attr('calendar.ferien', 'start_time'), None) | timestamp_custom("%w", True) | int(0) %}

              {{ ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][weekday-1] }}, {{ as_timestamp(state_attr('calendar.ferien', 'start_time'), None) | timestamp_custom("%d.%m.%Y", True) | string }}
            {% else %}
              -
            {% endif %}
          tage: >
            {% set start = as_timestamp(state_attr('calendar.ferien', 'start_time'), None) | int(0) %}
            {% set heute = as_timestamp(now().replace(hour=0, minute=0, second=0)) | int(0) %}
            
            {{ 0 if start == 0 else ((start - heute) | int / 60 / 60 / 24) | int(0) }}         